# 订阅管理系统设计文档（精简版）

## 1. 项目概述

### 1.1 项目目标与范围

**一句话描述**：\
*一个基于 Cloudflare 全栈技术（Pages + D1 + R2）的订阅管理系统，支持用户配置定时提醒规则，提供 Web 端管理界面。*

**当前迭代范围（MVP）**：

* ✅ **包含**：用户注册/登录、订阅 CRUD、基础设置（时间配置、开关）、头像上传

* ⏸️ **预留（迭代2）**：微信推送渠道配置、模板消息管理

* ⏸️ **预留（迭代3）**：定时任务触发、消息推送执行、推送历史记录

**技术边界**：

* 纯 Cloudflare Pages（ Functions 提供 API）

* 零服务器运维，边缘部署

* 单一代码库，前后端类型共享

***

## 2. 需求分析

### 2.1 功能需求（当前迭代）

| 功能模块      | 详细需求                      | 优先级 | 备注              |
| --------- | ------------------------- | --- | --------------- |
| **登录/注册** | 邮箱+密码登录、JWT 会话保持、密码重置链接   | 高   | 密码 bcrypt 加密    |
| **订阅管理**  | 增删改查订阅规则（标题、提醒时间、启用状态）    | 高   | 时间格式 HH:MM      |
| **推送设置**  | 全局推送开关、渠道选择（仅 UI 展示，预留接口） | 中   | 渠道配置暂存数据库，不实际推送 |
| **个人中心**  | 头像上传（R2）、手机号修改、密码修改       | 中   | 头像预签名 URL 访问    |
| **系统设置**  | 农历显示开关、主题切换               | 低   | 存储在用户配置表中       |

### 2.2 非功能需求

| 需求类型    | 具体要求                                   |
| ------- | -------------------------------------- |
| **性能**  | 首屏 < 1.5s，API 响应 < 200ms（边缘缓存）         |
| **安全**  | JWT httpOnly Cookie、CORS 严格限制、头像上传类型校验 |
| **可扩展** | 预留 `channel_configs` JSON 字段，支持后续微信配置  |

***

## 3. 系统设计

### 3.1 整体架构（单部署架构）

```
┌─────────────────────────────────────────────────────────────┐
│                     Cloudflare Pages                        │
│  ┌──────────────┬─────────────────────┬──────────────────┐  │
│  │   静态资源    │   React SPA 前端     │  Functions API   │  │
│  │  (React App) │  (React Router)     │   (Hono.js)      │  │
│  └──────────────┴─────────────────────┴──────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Cloudflare D1                           │
│  ┌──────────┐  ┌──────────────┐  ┌──────────────────────┐  │
│  │   users  │  │subscriptions │  │   user_settings      │  │
│  └──────────┘  └──────────────┘  └──────────────────────┘  │
└─────────────────────────────────────────────────────────────┘
                              │
                              ▼
┌─────────────────────────────────────────────────────────────┐
│                     Cloudflare R2                           │
│                  user-avatars 存储桶                         │
└─────────────────────────────────────────────────────────────┘
```

**架构说明**：

* **单仓库**：`src/app/` 前端 + `src/api/` 后端 API，共享 `src/shared/` 类型

* **单部署**：一个 `wrangler.toml` 配置，一次部署同时发布前端和 API

* **无定时任务**：当前仅保存提醒时间，推送执行功能迭代3开发

### 3.2 模块设计

| 模块            | 职责                                                 | 技术实现               |
| ------------- | -------------------------------------------------- | ------------------ |
| **Frontend**  | React 19 + TypeScript + TailwindCSS V4 + shadcn/ui | Vite 构建，SPA 模式     |
| **API Layer** | Hono.js 轻量框架，处理 HTTP 请求                            | Pages Functions 路由 |
| **Auth**      | JWT 签发/验证、密码哈希                                     | `jose` 库 + bcrypt  |
| **Storage**   | 结构化数据 D1，非结构化文件 R2                                 | 原生绑定访问             |

***

## 4. 技术选型

| 层级       | 技术                          | 选型理由                                   |
| -------- | --------------------------- | -------------------------------------- |
| **前端框架** | React 19 + TypeScript       | 生态成熟，类型安全                              |
| **样式方案** | Tailwind CSS V4 + shadcn/ui | 原子化 CSS，组件即拿即用                         |
| **状态管理** | Zustand + React Query       | 轻量，支持服务端状态缓存                           |
| **后端框架** | **Hono.js**                 | 专为 Workers 设计，体积小（<500B），TypeScript 友好 |
| **数据库**  | Cloudflare D1 (SQLite)      | 边缘 SQLite，零运维，与 Pages 无缝集成             |
| **文件存储** | Cloudflare R2               | S3 兼容，用于头像存储                           |
| **部署**   | Cloudflare Pages            | 自动 CI/CD，全球 CDN                        |

***

## 5. 项目结构

```bash
subscription-cf/
├── src/
│   ├── app/                    # 前端应用 (Pages 托管)
│   │   ├── layout.tsx          # 根布局（导航栏、全局状态）
│   │   ├── page.tsx            # 首页（订阅列表）
│   │   ├── login/
│   │   │   └── page.tsx        # 登录页
│   │   ├── register/
│   │   │   └── page.tsx        # 注册页
│   │   ├── settings/
│   │   │   └── page.tsx        # 设置页（农历开关、推送配置 UI）
│   │   └── profile/
│   │       └── page.tsx        # 个人中心
│   ├── api/                    # Pages Functions API
│   │   ├── [[route]].ts        # Hono 路由入口
│   │   ├── routes/
│   │   │   ├── auth.ts         # 登录/注册/刷新
│   │   │   ├── subscriptions.ts # 订阅 CRUD
│   │   │   ├── settings.ts     # 用户设置
│   │   │   └── upload.ts       # 头像上传（R2）
│   │   └── middleware/
│   │       ├── auth.ts         # JWT 验证中间件
│   │       └── error.ts        # 全局错误处理
│   ├── shared/                 # 前后端共享代码
│   │   ├── types/
│   │   │   ├── index.ts        # 核心类型定义（User, Subscription 等）
│   │   │   └── api.ts          # API 请求/响应类型
│   │   └── utils/
│   │       ├── validation.ts   # 共享验证逻辑（邮箱、手机号）
│   │       └── constants.ts    # 常量（分页大小、允许的文件类型）
│   ├── components/             # React 组件
│   │   ├── ui/                 # shadcn/ui 基础组件
│   │   ├── navigation/         # Header/Footer
│   │   └── subscription/       # 订阅卡片、表单
│   ├── hooks/                  # 自定义 Hooks
│   │   ├── useAuth.ts          # 认证状态管理
│   │   └── useSubscription.ts  # 订阅数据获取
│   └── lib/                    # 前端工具
│       ├── api.ts              # Fetch 封装（自动携带 Token）
│       └── store.ts            # Zustand 全局状态
├── migrations/                 # D1 数据库迁移文件
│   ├── 0000_init.sql
│   └── 0001_add_settings.sql
├── public/                     # 静态资源（favicon 等）
├── wrangler.toml               # Cloudflare 配置（D1/R2 绑定）
├── package.json                # 依赖（workspaces 配置）
├── tsconfig.json               # TypeScript 配置（含路径别名 @/*）
├── tailwind.config.ts          # Tailwind 配置
└── vite.config.ts              # Vite 构建配置
```

***

## 6. 数据模型

### 6.1 表结构定义

```sql
-- 用户表
CREATE TABLE users (
    id TEXT PRIMARY KEY,                          -- UUID v4
    email TEXT UNIQUE NOT NULL,                   -- 登录邮箱
    username TEXT UNIQUE NOT NULL,                -- 显示用户名
    password_hash TEXT NOT NULL,                  -- bcrypt 哈希
    phone TEXT,                                   -- 可选手机号
    avatar_url TEXT,                              -- R2 文件路径
    created_at INTEGER DEFAULT (unixepoch()),     -- 创建时间戳
    updated_at INTEGER DEFAULT (unixepoch())      -- 更新时间戳
);

CREATE INDEX idx_users_email ON users(email);

-- 订阅表（提醒规则）
CREATE TABLE subscriptions (
    id TEXT PRIMARY KEY,
    user_id TEXT NOT NULL,
    title TEXT NOT NULL,                          -- 提醒标题
    reminder_time TEXT NOT NULL,                  -- 提醒时间 HH:MM（预留：迭代3据此执行推送）
    is_enabled BOOLEAN DEFAULT 1,                 -- 是否启用
    push_channel TEXT DEFAULT 'wechat',           -- 预留：推送渠道（wechat/qywechat/none）
    -- 预留扩展字段：迭代2存储微信模板配置，迭代3存储推送日志关联
    channel_config TEXT,                          -- JSON 格式：{"template_id": "xxx", "openid": "xxx"}
    created_at INTEGER DEFAULT (unixepoch()),
    updated_at INTEGER DEFAULT (unixepoch()),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);

CREATE INDEX idx_subscriptions_user_id ON subscriptions(user_id);
CREATE INDEX idx_subscriptions_time ON subscriptions(reminder_time); -- 迭代3用于查询待推送任务

-- 用户设置表
CREATE TABLE user_settings (
    user_id TEXT PRIMARY KEY,
    show_lunar BOOLEAN DEFAULT 0,                 -- 农历显示开关
    push_enabled BOOLEAN DEFAULT 1,               -- 全局推送开关（仅控制前端显示）
    theme TEXT DEFAULT 'system',                  -- 主题：light/dark/system
    updated_at INTEGER DEFAULT (unixepoch()),
    FOREIGN KEY (user_id) REFERENCES users(id) ON DELETE CASCADE
);
```

### 6.2 TypeScript 类型定义（`src/shared/types/index.ts`）

```typescript
// 用户类型
export interface User {
  id: string;
  email: string;
  username: string;
  phone?: string;
  avatarUrl?: string;
  createdAt: number;
}

// 订阅类型（当前迭代仅存储配置）
export interface Subscription {
  id: string;
  userId: string;
  title: string;
  reminderTime: string; // HH:MM 格式
  isEnabled: boolean;
  pushChannel: 'wechat' | 'qywechat' | 'none';
  channelConfig?: Record<string, string>; // 预留：微信配置（迭代2使用）
  createdAt: number;
  updatedAt: number;
}

// 用户设置类型
export interface UserSettings {
  userId: string;
  showLunar: boolean;
  pushEnabled: boolean;
  theme: 'light' | 'dark' | 'system';
}

// API 通用响应类型
export interface ApiResponse<T = unknown> {
  success: boolean;
  data?: T;
  error?: string;
  message?: string;
}

// Cloudflare 环境绑定类型
export interface Env {
  DB: D1Database;
  AVATARS_BUCKET: R2Bucket;
  JWT_SECRET: string;
  // 预留：迭代2添加微信 API 密钥
  // WECHAT_APPID?: string;
  // WECHAT_SECRET?: string;
}
```

***

## 7. API 设计（Pages Functions）

### 7.1 路由结构（Hono.js）

```typescript
// src/api/[[route]].ts
import { Hono } from 'hono';
import { handle } from 'hono/cloudflare-pages';
import { authRouter } from './routes/auth';
import { subscriptionRouter } from './routes/subscriptions';
import { settingsRouter } from './routes/settings';
import { uploadRouter } from './routes/upload';
import { authMiddleware } from './middleware/auth';

const app = new Hono<{ Bindings: Env }>();

// CORS 中间件
app.use('*', async (c, next) => {
  const origin = c.env.ENVIRONMENT === 'development' ? 'http://localhost:5173' : c.req.header('Origin') || '';
  c.header('Access-Control-Allow-Origin', origin);
  c.header('Access-Control-Allow-Credentials', 'true');
  c.header('Access-Control-Allow-Methods', 'GET, POST, PUT, DELETE, OPTIONS');
  c.header('Access-Control-Allow-Headers', 'Content-Type, Authorization');
  
  if (c.req.method === 'OPTIONS') return c.body(null, 204);
  await next();
});

// 健康检查
app.get('/api/health', (c) => c.json({ status: 'ok', env: c.env.ENVIRONMENT }));

// 公开路由
app.route('/api/auth', authRouter);

// 受保护路由
app.use('/api/*', authMiddleware);
app.route('/api/subscriptions', subscriptionRouter);
app.route('/api/settings', settingsRouter);
app.route('/api/upload', uploadRouter);

export const onRequest = handle(app);
```

### 7.2 核心端点清单

| 方法     | 路径                       | 描述            | 认证 |
| ------ | ------------------------ | ------------- | -- |
| POST   | `/api/auth/login`        | 邮箱密码登录，返回 JWT | 否  |
| POST   | `/api/auth/register`     | 用户注册          | 否  |
| POST   | `/api/auth/refresh`      | 刷新 Token      | 是  |
| GET    | `/api/subscriptions`     | 获取当前用户订阅列表    | 是  |
| POST   | `/api/subscriptions`     | 创建订阅          | 是  |
| PUT    | `/api/subscriptions/:id` | 更新订阅          | 是  |
| DELETE | `/api/subscriptions/:id` | 删除订阅          | 是  |
| GET    | `/api/settings`          | 获取用户设置        | 是  |
| PATCH  | `/api/settings`          | 更新设置（农历、主题等）  | 是  |
| POST   | `/api/upload/avatar`     | 上传头像到 R2      | 是  |

***

## 8. 开发计划（三阶段）

### 阶段1：基础架构与认证（4天）

**目标**：可运行的前后端框架，完成登录注册

* [ ] Day 1: 项目初始化（Bun + Vite + Hono + Tailwind）

* [ ] Day 2: 数据库设计（D1 表创建）+ 共享类型定义

* [ ] Day 3: 登录/注册页面前端 + API 实现

* [ ] Day 4: JWT 中间件 + 前端路由保护 + 全局状态管理

**交付物**：可访问的登录系统，用户可注册并进入首页

### 阶段2：核心订阅功能（4天）

**目标**：完整的订阅 CRUD 和基础设置

* [ ] Day 5: 订阅列表页面（展示、空状态）

* [ ] Day 6: 订阅新增/编辑表单（时间选择器）

* [ ] Day 7: 订阅 API（CRUD）+ 软删除逻辑

* [ ] Day 8: 设置页面（农历开关、主题切换）+ API

**交付物**：用户可创建提醒规则，设置偏好

### 阶段3：个人中心与优化（2天）

**目标**：头像上传、密码修改、性能优化

* [ ] Day 9: 头像上传功能（R2 预签名 URL）+ 裁剪组件

* [ ] Day 10: 密码修改、手机号绑定 + 响应式优化

**交付物**：完整的 MVP，可部署生产环境

### 后续迭代 roadmap（预留）

* **迭代2（4天）**：微信配置界面、模板消息管理、渠道 Config 存储

* **迭代3（5天）**：定时任务 Worker、推送执行逻辑、推送历史表

***

## 9. 环境准备

### 9.1 开发环境配置

**依赖安装**：

```bash
# 创建项目
mkdir subscription-cf && cd subscription-cf
bun init -y

# 安装核心依赖
bun add react react-dom react-router-dom zustand @tanstack/react-query
bun add hono jose bcryptjs  # 后端使用 Hono，JWT 使用 jose
bun add -d @types/react @types/react-dom @types/bcryptjs
bun add -d typescript vite @vitejs/plugin-react tailwindcss postcss autoprefixer
bun add -d wrangler@latest
```

**wrangler.toml 配置**：

```toml
name = "subscription-system"
compatibility_date = "2024-01-29"

# 生产环境变量（不含敏感信息，仅配置标识）
[env.production]
vars = { ENVIRONMENT = "production" }

# D1 数据库绑定
[[env.production.d1_databases]]
binding = "DB"
database_name = "subscription-db"
database_id = "your-database-id"

# R2 头像存储
[[env.production.r2_buckets]]
binding = "AVATARS_BUCKET"
bucket_name = "user-avatars"

# 开发环境（本地 wrangler dev 使用）
[env.development]
vars = { ENVIRONMENT = "development" }

[[env.development.d1_databases]]
binding = "DB"
database_name = "subscription-db-dev"
database_id = "local"  # 本地使用 wrangler d1 本地模式
```

### 9.2 本地开发命令

```bash
# 1. 初始化数据库（首次）
bunx wrangler d1 create subscription-db-dev
bunx wrangler d1 migrations apply subscription-db-dev --local

# 2. 启动本地开发服务器（同时启动前端和 Functions）
bun run dev

# 3. 打包部署
bun run build
bunx wrangler pages deploy dist

# 数据库迁移（生产环境）
bunx wrangler d1 migrations apply subscription-db
```

### 9.3 关键配置说明

**D1 本地开发流程**：

```bash
# 创建迁移文件
echo "CREATE TABLE users ..." > migrations/0001_init.sql

# 应用到本地数据库
wrangler d1 migrations apply subscription-db-dev --local

# 查看本地数据
wrangler d1 execute subscription-db-dev --local --command "SELECT * FROM users"
```

**R2 头像访问策略**：

* 上传：通过 `/api/upload/avatar` 生成预签名 URL，前端直传 R2

* 访问：R2 Bucket 设置为公共读，或通过 Workers 代理（根据隐私需求选择）

***

## 10. 安全与性能建议

### 10.1 安全 hardening

1. **JWT 策略**：

   * Access Token: 15 分钟有效期，存储在 httpOnly Cookie

   * Refresh Token: 7 天有效期，存储在 D1 `refresh_tokens` 表（支持吊销）

2. **上传限制**：

   * 头像仅允许 jpg/png，最大 2MB

   * R2 Key 使用 `avatars/{userId}/{timestamp}.jpg` 避免冲突

3. **CORS 严格模式**：

   * 生产环境只允许特定域名（ configured in wrangler.toml vars ）

### 10.2 性能优化

1. **边缘缓存**：

   * 静态资源：Cloudflare Pages 自动 CDN 缓存

   * API：对 `/api/settings` 等低频变更接口设置 `Cache-Control: max-age=60`

2. **数据库优化**：

   * 所有查询使用 D1 索引（已在上文 SQL 中定义）

   * 分页查询：默认每页 20 条，最大 100 条

3. **前端优化**：

   * 路由懒加载（React.lazy）

   * React Query 缓存订阅数据，减少 API 调用

***

## 11. 部署清单

部署前确认以下配置：

* [ ] `wrangler.toml` 中 `database_id` 已更新为生产环境 ID

* [ ] R2 Bucket `user-avatars` 已创建并设置 CORS

* [ ] 环境变量 `JWT_SECRET` 已在 Cloudflare Dashboard 设置（Encryption）

* [ ] 自定义域名（可选）在 Pages 设置中配置

* [ ] 数据库迁移已执行：`wrangler d1 migrations apply subscription-db`

* [ ] 前端环境变量 `.env.production` 中 API 地址配置正确

***

